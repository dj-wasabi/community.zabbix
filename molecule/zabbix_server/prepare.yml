---
- name: Prepare
  hosts: all
  pre_tasks:
    - name: "Installing packages on CentOS"
      yum:
        name:
          - net-tools
          - which
          - libselinux-python
          - sudo
        state: present
      register: installation_dependencies
      until: installation_dependencies is succeeded
      when:
        - ansible_os_family == 'RedHat'

    - name: "Apt update"
      shell: "apt-get update && echo exit 0 > /usr/sbin/policy-rc.d"
      args:
        warn: False
      register: installation_dependencies
      until: installation_dependencies is succeeded
      when:
        - ansible_os_family != 'RedHat'

    - name: "Installing packages on NON-CentOS"
      apt:
        name:
          - net-tools
          - apt-utils
          - python3-pip
          - sudo
        update_cache: True
        state: present
      register: installation_dependencies
      until: installation_dependencies is succeeded
      when:
        - ansible_os_family != 'RedHat'

    - name: PyMySQL
      pip:
        name: PyMySQL
      register: installation_dependencies
      until: installation_dependencies is succeeded
      when:
        - ansible_distribution == 'Ubuntu'

    - name: "Configure SUDO."
      lineinfile:
        dest: /etc/sudoers
        line: "Defaults    !requiretty"
        state: present

    - name: "Make sure the docs are installed."
      lineinfile:
        dest: /etc/yum.conf
        line: "tsflags=nodocs"
        state: absent
      when:
        - ansible_os_family == 'RedHat'

    - name: "Create group for imaginary host"
      add_host:
        name: imaginary-host
        groups:
          - mysql
          - postgresql
      changed_when: False

    - name: "Installing MySQL Server"
      shell: "{{ item }}"
      args:
        warn: False
      register: installation_dependencies
      until: installation_dependencies is succeeded
      with_items:
        - apt-get remove --purge mariadb-server mariadb-client
        - apt-get autoremove
        - apt-get autoclean
        - apt-get install mariadb-server mariadb-client
      when:
        - ansible_os_family != 'RedHat'
        - inventory_hostname in groups['mysql']

    - name: "Start MySQL"
      service:
        name: mysql
        state: started
      when:
        - ansible_os_family != 'RedHat'
        - inventory_hostname in groups['mysql']

  roles:
    - role: geerlingguy.postgresql
      when: inventory_hostname in groups['postgresql']
    - role: geerlingguy.mysql
      when:
        - ansible_os_family == 'RedHat'
        - inventory_hostname in groups['mysql']
